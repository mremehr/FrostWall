#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="${STATE_DIR:-/tmp/displayfrost-observer}"
URL_FILE="$STATE_DIR/stream.url"
FRAMES_DIR="$STATE_DIR/frames"

url=""
out=""
mode="auto"

usage() {
  cat <<'EOF'
Usage: observer-frame [--url URL] [--out FILE] [--mode auto|hls|grim]
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --url)
      url="${2:-}"
      shift 2
      ;;
    --out)
      out="${2:-}"
      shift 2
      ;;
    --mode)
      mode="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 2
      ;;
  esac
done

mkdir -p "$FRAMES_DIR"

if [[ -z "$out" ]]; then
  ts="$(date +%Y%m%d_%H%M%S)"
  out="$FRAMES_DIR/frame_${ts}.jpg"
fi

capture_with_grim() {
  if ! command -v grim >/dev/null 2>&1; then
    echo "grim not found for fallback capture" >&2
    return 1
  fi
  grim "$out"
  if [[ ! -f "$out" ]]; then
    echo "grim capture did not produce output: $out" >&2
    return 1
  fi
  echo "$out"
}

capture_with_hls() {
  if [[ -z "$url" && -f "$URL_FILE" ]]; then
    url="$(cat "$URL_FILE")"
  fi
  if [[ -z "$url" ]]; then
    echo "No stream URL. Start observer first or pass --url." >&2
    return 1
  fi
  if ! ffmpeg -hide_banner -loglevel error -y -i "$url" -frames:v 1 "$out"; then
    return 1
  fi
  if [[ ! -f "$out" ]]; then
    echo "ffmpeg capture did not produce output: $out" >&2
    return 1
  fi
  echo "$out"
}

case "$mode" in
  grim)
    capture_with_grim
    ;;
  hls)
    capture_with_hls
    ;;
  auto)
    if capture_with_hls; then
      exit 0
    fi
    capture_with_grim
    ;;
  *)
    echo "Unknown mode: $mode (expected auto|hls|grim)" >&2
    exit 2
    ;;
esac
