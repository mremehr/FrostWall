#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="${STATE_DIR:-/tmp/displayfrost-observer}"
PID_FILE="$STATE_DIR/stream.pid"
LOG_FILE="$STATE_DIR/stream.log"
URL_FILE="$STATE_DIR/stream.url"
DEFAULT_DISPLAYFROST_REPO="/home/mrmattias/git/FrostWall/tools/displayfrost-hardfork"
DISPLAYFROST_REPO="${DISPLAYFROST_REPO:-$DEFAULT_DISPLAYFROST_REPO}"
DISPLAYFROST_BIN="${DISPLAYFROST_BIN:-$DISPLAYFROST_REPO/target/release/displayfrost}"

port=8888
output=""
iface=""

usage() {
  cat <<'EOF'
Usage: observer-start [--port N] [--output NAME] [--interface IFACE]
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --port)
      port="${2:-}"
      shift 2
      ;;
    --output)
      output="${2:-}"
      shift 2
      ;;
    --interface)
      iface="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 2
      ;;
  esac
done

mkdir -p "$STATE_DIR"

if [[ -f "$PID_FILE" ]]; then
  existing_pid="$(cat "$PID_FILE" || true)"
  if [[ -n "${existing_pid:-}" ]] && kill -0 "$existing_pid" 2>/dev/null; then
    echo "observer already running (pid=$existing_pid)"
    if [[ -f "$URL_FILE" ]]; then
      echo "stream url: $(cat "$URL_FILE")"
    fi
    exit 0
  fi
  rm -f "$PID_FILE"
fi

cmd=()
if [[ -x "$DISPLAYFROST_BIN" ]] \
  && "$DISPLAYFROST_BIN" chromecast start --help 2>&1 | grep -q -- "--stream-only"; then
  cmd=("$DISPLAYFROST_BIN" "chromecast" "start" "--stream-only" "--port" "$port")
else
  if ! command -v cargo >/dev/null 2>&1; then
    echo "cargo is required for fallback run but was not found in PATH" >&2
    exit 1
  fi
  manifest="$DISPLAYFROST_REPO/Cargo.toml"
  if [[ ! -f "$manifest" ]]; then
    echo "DisplayFrost manifest not found for fallback: $manifest" >&2
    exit 1
  fi
  echo "Using cargo fallback (DisplayFrost binary lacks --stream-only or is missing)"
  cmd=(cargo run --quiet --manifest-path "$manifest" -- chromecast start --stream-only --port "$port")
fi
if [[ -n "$output" ]]; then
  cmd+=("--output" "$output")
fi
if [[ -n "$iface" ]]; then
  cmd+=("--interface" "$iface")
fi

: > "$LOG_FILE"
if command -v setsid >/dev/null 2>&1; then
  setsid "${cmd[@]}" >>"$LOG_FILE" 2>&1 < /dev/null &
else
  nohup "${cmd[@]}" >>"$LOG_FILE" 2>&1 < /dev/null &
fi
pid=$!
echo "$pid" > "$PID_FILE"

url=""
for _ in $(seq 1 80); do
  if ! kill -0 "$pid" 2>/dev/null; then
    echo "displayfrost exited early, see $LOG_FILE" >&2
    exit 1
  fi
  url="$(grep -Eo 'http://[^ ]+/stream\.m3u8' "$LOG_FILE" | tail -n 1 || true)"
  if [[ -n "$url" ]]; then
    break
  fi
  sleep 0.25
done

if [[ -n "$url" ]]; then
  echo "$url" > "$URL_FILE"
  echo "observer stream started (pid=$pid)"
  echo "stream url: $url"
else
  echo "observer stream started (pid=$pid), URL not detected yet"
  echo "log: $LOG_FILE"
fi
